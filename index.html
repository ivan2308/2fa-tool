<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H2 æé€Ÿ 2FA (äº‘åŒæ­¥ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.1.4/otpauth.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            margin: 0;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 24px;
            position: relative;
        }

        h2 { text-align: center; margin-bottom: 20px; color: #111827; }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        
        .btn-sync {
            background-color: var(--success-color);
            color: white;
            font-size: 0.9rem;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* éªŒè¯ç å¡ç‰‡æ ·å¼ */
        .token-list { list-style: none; padding: 0; margin: 0; }
        
        .token-item {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.1s;
        }
        
        .token-item:active { transform: scale(0.99); }

        .token-info h3 { margin: 0; font-size: 0.95rem; color: #6b7280; font-weight: 500; }
        .token-code {
            font-family: 'Courier New', monospace;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: 3px;
            margin-top: 4px;
        }

        .btn-delete {
            background: transparent;
            color: #ef4444;
            border: 1px solid #ef4444;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 10px;
        }

        /* å€’è®¡æ—¶æ¡ */
        .countdown-bar {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: #e5e7eb;
            border-radius: 16px 16px 0 0;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background: var(--primary-color);
            width: 100%;
            transition: width 1s linear;
        }

        /* æ·»åŠ è¡¨å•åŒºåŸŸ */
        .add-section {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px dashed #d1d5db;
        }
        .input-group { margin-bottom: 10px; }
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-sizing: border-box;
        }
        .btn-add {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        /* æ¨¡æ€æ¡† (å¼¹çª—) */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        .modal-input {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btns button { flex: 1; padding: 10px; border-radius: 6px; border: none; cursor: pointer; }
        .btn-confirm { background: var(--primary-color); color: white; }
        .btn-cancel { background: #e5e7eb; color: #374151; }

    </style>
</head>
<body>

<div class="container">
    <div class="countdown-bar"><div class="progress" id="progressBar"></div></div>
    
    <div class="toolbar">
        <button class="btn-sync" onclick="showSyncModal()">â˜ï¸ è·¨è®¾å¤‡åŒæ­¥</button>
    </div>

    <h2 id="pageTitle">æˆ‘çš„ 2FA ä»¤ç‰Œ</h2>

    <ul class="token-list" id="tokenList"></ul>

    <div class="add-section">
        <div class="input-group">
            <input type="text" id="accName" placeholder="è´¦æˆ·åç§° (å¦‚: Google é‚®ç®±)">
        </div>
        <div class="input-group">
            <input type="text" id="accSecret" placeholder="å¯†é’¥ (Secret Key)">
        </div>
        <button class="btn-add" onclick="addAccount()">+ æ·»åŠ æ–°è´¦æˆ·</button>
    </div>
</div>

<div id="syncModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">ç”ŸæˆåŒæ­¥é“¾æ¥</h3>
        <p style="font-size: 0.9em; color: #666;" id="modalDesc">
            è®¾ç½®ä¸€ä¸ªå¯†ç æ¥åŠ å¯†ä½ çš„æ•°æ®ã€‚ç”Ÿæˆçš„é“¾æ¥å¯ä»¥å‘é€ç»™å…¶ä»–è®¾å¤‡æ‰“å¼€ã€‚
        </p>
        <input type="password" id="syncPassword" class="modal-input" placeholder="è®¾ç½®åŠ å¯†å¯†ç ">
        <div class="modal-btns">
            <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn-confirm" id="modalActionBtn" onclick="generateLink()">ç”Ÿæˆé“¾æ¥</button>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY = 'h2_2fa_data';
    let accounts = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let importDataString = null; // ç”¨äºå­˜å‚¨å¾…å¯¼å…¥çš„æ•°æ®

    // 1. åˆå§‹åŒ–ï¼šæ£€æŸ¥URLæ˜¯å¦æœ‰æ•°æ®ï¼ˆæ˜¯å¦æ˜¯åŒæ­¥æ“ä½œï¼‰
    window.onload = function() {
        const hash = window.location.hash;
        if (hash && hash.startsWith('#sync=')) {
            // å¦‚æœé“¾æ¥é‡Œæœ‰ sync=... è¯´æ˜æ˜¯æ¥å¯¼å…¥æ•°æ®çš„
            importDataString = hash.substring(6); // å»æ‰ #sync=
            
            // ä¿®æ”¹ç•Œé¢ä¸ºâ€œå¯¼å…¥æ¨¡å¼â€
            document.getElementById('syncModal').style.display = 'flex';
            document.getElementById('modalTitle').innerText = 'ğŸ” è§£é”åŒæ­¥æ•°æ®';
            document.getElementById('modalDesc').innerText = 'æ£€æµ‹åˆ°åŒæ­¥æ•°æ®ï¼Œè¯·è¾“å…¥å¯†ç è¿›è¡Œè§£å¯†å’Œå¯¼å…¥ã€‚æ³¨æ„ï¼šè¿™å°†è¦†ç›–å½“å‰çš„è®°å½•ã€‚';
            document.getElementById('syncPassword').placeholder = 'è¾“å…¥å¯¹æ–¹è®¾ç½®çš„å¯†ç ';
            
            const actionBtn = document.getElementById('modalActionBtn');
            actionBtn.innerText = 'è§£å¯†å¹¶å¯¼å…¥';
            actionBtn.onclick = decryptAndImport;
        } else {
            renderList();
        }
    };

    // 2. æ ¸å¿ƒåŠŸèƒ½ï¼šç”ŸæˆéªŒè¯ç å¹¶æ¸²æŸ“
    function renderList() {
        const list = document.getElementById('tokenList');
        list.innerHTML = '';
        
        if(accounts.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æš‚æ— æ•°æ®<br>è¯·ä¸‹æ–¹æ·»åŠ å¯†é’¥æˆ–ä½¿ç”¨åŒæ­¥åŠŸèƒ½</div>';
            return;
        }

        accounts.forEach((acc, idx) => {
            let code = '...';
            try {
                const totp = new OTPAuth.TOTP({
                    algorithm: 'SHA1', digits: 6, period: 30,
                    secret: OTPAuth.Secret.fromBase32(acc.secret.replace(/\s/g,''))
                });
                code = totp.generate();
            } catch(e) { code = 'KEY ERROR'; }

            const li = document.createElement('li');
            li.className = 'token-item';
            li.innerHTML = `
                <div class="token-info"><h3>${acc.name}</h3><div class="token-code">${code}</div></div>
                <button class="btn-delete" onclick="delAccount(${idx})">Ã—</button>
            `;
            list.appendChild(li);
        });
    }

    // 3. æ·»åŠ è´¦æˆ·
    function addAccount() {
        const name = document.getElementById('accName').value.trim();
        const secret = document.getElementById('accSecret').value.trim();
        if(!name || !secret) return alert('è¯·å¡«å†™å®Œæ•´');
        
        accounts.push({ name, secret });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(accounts));
        renderList();
        
        document.getElementById('accName').value = '';
        document.getElementById('accSecret').value = '';
    }

    function delAccount(idx) {
        if(confirm('ç¡®å®šåˆ é™¤?')) {
            accounts.splice(idx, 1);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(accounts));
            renderList();
        }
    }

    // 4. åŒæ­¥åŠŸèƒ½ - ç”Ÿæˆé“¾æ¥
    function showSyncModal() {
        document.getElementById('syncModal').style.display = 'flex';
        // é‡ç½®ä¸ºç”Ÿæˆæ¨¡å¼
        document.getElementById('modalTitle').innerText = 'â˜ï¸ ç”ŸæˆåŒæ­¥é“¾æ¥';
        document.getElementById('modalDesc').innerText = 'è®¾ç½®å¯†ç åŠ å¯†æ•°æ®ã€‚ç”Ÿæˆçš„é“¾æ¥è¯·åœ¨ 30 åˆ†é’Ÿå†…ä½¿ç”¨ï¼ˆè™½ç„¶æ°¸ä¹…æœ‰æ•ˆï¼Œä½†å»ºè®®å°½å¿«åŒæ­¥ï¼‰ã€‚';
        document.getElementById('syncPassword').placeholder = 'è®¾ç½®ä¸€ä¸ªä¸´æ—¶å¯†ç ';
        const btn = document.getElementById('modalActionBtn');
        btn.innerText = 'å¤åˆ¶é“¾æ¥';
        btn.onclick = generateLink;
    }

    function generateLink() {
        const pwd = document.getElementById('syncPassword').value;
        if(!pwd) return alert('ä¸ºäº†å®‰å…¨ï¼Œå¿…é¡»è®¾ç½®å¯†ç ï¼');
        if(accounts.length === 0) return alert('ä½ è¿˜æ²¡æœ‰ä»»ä½•è´¦æˆ·æ•°æ®å¯åŒæ­¥');

        try {
            // åŠ å¯†æ•°æ®
            const dataStr = JSON.stringify(accounts);
            const encrypted = CryptoJS.AES.encrypt(dataStr, pwd).toString();
            
            // æ„å»ºURL (å½“å‰é¡µé¢URL + #sync=åŠ å¯†æ•°æ®)
            // æ³¨æ„ï¼šå› ä¸ºURLæœ‰é•¿åº¦é™åˆ¶ï¼Œå¦‚æœæ•°æ®å¤ªå¤šå¯èƒ½ä¼šå¤±è´¥ï¼Œä½†å‡ åä¸ªè´¦å·é€šå¸¸æ²¡é—®é¢˜
            const baseUrl = window.location.href.split('#')[0];
            const syncUrl = `${baseUrl}#sync=${encodeURIComponent(encrypted)}`;

            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(syncUrl).then(() => {
                alert('âœ… é“¾æ¥å·²å¤åˆ¶ï¼\nè¯·å°†æ­¤é“¾æ¥å‘é€åˆ°ä½ çš„æ‰‹æœºæˆ–å…¶ä»–ç”µè„‘æ‰“å¼€ï¼Œè¾“å…¥ç›¸åŒå¯†ç å³å¯åŒæ­¥ã€‚');
                closeModal();
            }).catch(err => {
                prompt("è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹é“¾æ¥ï¼š", syncUrl);
            });

        } catch(e) {
            alert('ç”Ÿæˆå¤±è´¥: ' + e.message);
        }
    }

    // 5. åŒæ­¥åŠŸèƒ½ - è§£å¯†å¯¼å…¥
    function decryptAndImport() {
        const pwd = document.getElementById('syncPassword').value;
        if(!pwd) return alert('è¯·è¾“å…¥å¯†ç ');

        try {
            // è§£ç URLæ•°æ®
            const encrypted = decodeURIComponent(importDataString);
            // è§£å¯†
            const bytes = CryptoJS.AES.decrypt(encrypted, pwd);
            const decryptedData = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));

            if(Array.isArray(decryptedData)) {
                if(confirm(`æˆåŠŸè§£å¯†ï¼å‘ç°äº† ${decryptedData.length} ä¸ªè´¦æˆ·ã€‚\nç‚¹å‡»ç¡®å®šå°†è¦†ç›–å½“å‰æµè§ˆå™¨çš„è®°å½•ã€‚`)) {
                    accounts = decryptedData;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(accounts));
                    window.location.hash = ''; // æ¸…é™¤URL hash
                    closeModal();
                    renderList();
                    alert('å¯¼å…¥æˆåŠŸï¼');
                }
            } else {
                throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
            }
        } catch(e) {
            alert('âŒ å¯†ç é”™è¯¯æˆ–æ•°æ®æŸåï¼Œè¯·é‡è¯•ã€‚');
        }
    }

    function closeModal() {
        document.getElementById('syncModal').style.display = 'none';
        document.getElementById('syncPassword').value = '';
    }

    // å®šæ—¶å™¨
    setInterval(() => {
        const epoch = Math.round(new Date().getTime() / 1000.0);
        document.getElementById('progressBar').style.width = ((30 - (epoch % 30)) / 30 * 100) + '%';
        if(epoch % 30 === 0) renderList();
    }, 1000);

    renderList();
</script>

</body>
</html>
